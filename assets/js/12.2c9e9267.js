(window.webpackJsonp=window.webpackJsonp||[]).push([[12],{375:function(t,s,a){"use strict";a.r(s);var n=a(45),e=Object(n.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"eos"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#eos"}},[t._v("#")]),t._v(" EOS")]),t._v(" "),a("p",[t._v("线上错误监控系统————线上出错的第一时间，直接追踪到源码及对应的代码开发者，并进行通知。")]),t._v(" "),a("img",{attrs:{src:"https://melodyworld.oss-cn-beijing.aliyuncs.com/tulongshu/EOS%E5%85%A8%E9%93%BE%E8%B7%AF%E5%9B%BE.jpg",width:"800",height:"600"}}),t._v(" "),a("p",[t._v("如图所示，")]),t._v(" "),a("ol",[a("li",[t._v("客户端运行静态资源代码(HTML, JS)发生错误时，通过异常捕获后的回调，上报到服务端(一般都会上报到运维那边的日志服务台)；")]),t._v(" "),a("li",[t._v("然后服务端判断是ERROR类型，即可将其发送给EOS(也可以EOS主动获取)；")]),t._v(" "),a("li",[t._v("EOS对错误信息进错误源映射追踪，从而找到错误发生的源码位置；通过拿到源码文件及行列，通过git追踪到对应的最后一个commit提交者，或称“肇事者”；")]),t._v(" "),a("li",[t._v('EOS将错误源及时通知给"肇事者"。')])]),t._v(" "),a("h3",{attrs:{id:"意义"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#意义"}},[t._v("#")]),t._v(" 意义：")]),t._v(" "),a("p",[t._v("第一时间发现并解决线上问题的根源，保障业务的稳定性。")]),t._v(" "),a("h2",{attrs:{id:"核心代码"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#核心代码"}},[t._v("#")]),t._v(" 核心代码")]),t._v(" "),a("h3",{attrs:{id:"异常捕获"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#异常捕获"}},[t._v("#")]),t._v(" 异常捕获")]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[t._v("    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// js error, 异步error 捕获")]),t._v("\n    window"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("addEventListener")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'error'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("event")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// event.error; error对象 { massage, stack }  ")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 关键是event.error.stack一定要上报上去！")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// report...")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 静态资源异常捕获")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("HTMLImageElement")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("prototype"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("onerror")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("event")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("throw")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Error")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("event"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n")])])]),a("h3",{attrs:{id:"源码追踪-sourcemap、"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#源码追踪-sourcemap、"}},[t._v("#")]),t._v(" 源码追踪 - sourceMap、")]),t._v(" "),a("ol",[a("li",[a("p",[t._v("打包出map文件和bundle；(线上不要上传map文件)\nwebpackconfig配置：")]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[t._v("    devtool"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'source-map'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n")])])]),a("p",[t._v("附录： webpack——devtool里的7种SourceMap模式")]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",[t._v("模式")]),t._v(" "),a("th",[t._v("解释")])])]),t._v(" "),a("tbody",[a("tr",[a("td",[t._v("eval")]),t._v(" "),a("td",[t._v("每个module会封装到 eval 里包裹起来执行，并且会在末尾追加注释 //@ sourceURL.")])]),t._v(" "),a("tr",[a("td",[t._v("source-map")]),t._v(" "),a("td",[t._v("生成一个SourceMap文件.")])]),t._v(" "),a("tr",[a("td",[t._v("hidden-source-map")]),t._v(" "),a("td",[t._v("和 source-map 一样，但不会在 bundle 末尾追加注释.")])]),t._v(" "),a("tr",[a("td",[t._v("inline-source-map")]),t._v(" "),a("td",[t._v("生成一个 DataUrl 形式的 SourceMap 文件.")])]),t._v(" "),a("tr",[a("td",[t._v("eval-source-map")]),t._v(" "),a("td",[t._v("每个module会通过eval()来执行，并且生成一个DataUrl形式的SourceMap.")])]),t._v(" "),a("tr",[a("td",[t._v("cheap-source-map")]),t._v(" "),a("td",[t._v("生成一个没有列信息（column-mappings）的SourceMaps文件，不包含loader的 sourcemap（譬如 babel 的 sourcemap）")])]),t._v(" "),a("tr",[a("td",[t._v("cheap-module-source-map")]),t._v(" "),a("td",[t._v("生成一个没有列信息（column-mappings）的SourceMaps文件，同时 loader 的 sourcemap 也被简化为只包含对应行的。")])])])]),t._v(" "),a("blockquote",[a("p",[t._v("打包效果如图：")])]),t._v(" "),a("img",{attrs:{src:"https://melodyworld.oss-cn-beijing.aliyuncs.com/tulongshu/souce-map-file.jpg",width:"500",height:"150"}})]),t._v(" "),a("li",[a("p",[t._v("基于map文件和errorMsg错误源追踪")]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" fs "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'fs'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" SourceMap "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'source-map'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" readFileSync "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" fs"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" rawSourceMap "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("JSON")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("parse")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("readFileSync")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'path/to/js/map/file'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'utf8'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 真实报错的点在客户端error事件的event.error.stack中")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" mockErrorMsg "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    line"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    column"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("982")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\nSourceMap"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("SourceMapConsumer"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("with")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("rawSourceMap"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("consumer")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" pos "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" consumer"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("originalPositionFor")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("mockErrorMsg"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nconsole"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("pos"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/** \n * 查找到的原始信息\n{ \n    source: 'path/to/index.js',\n    line: 8,\n    column: 7,\n    name: 'hello' \n} \n **/")]),t._v("\n")])])])])]),t._v(" "),a("h3",{attrs:{id:"开发者追踪-git-blame"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#开发者追踪-git-blame"}},[t._v("#")]),t._v(" 开发者追踪 - git blame")]),t._v(" "),a("blockquote",[a("p",[t._v('如果只查文件中某一部分由谁所写： git blame 文件名 | grep "查找词"')])]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("    "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("git")]),t._v(" blame "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("文件名"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" -L  a,b\n")])])]),a("ul",[a("li",[t._v("-L 参数表示后面接的是行号(Line)， a,b代表查询文件的第a行到第b行之间的文件内容情况。")]),t._v(" "),a("li",[t._v("a: 代表从第a行到文件结尾,")]),t._v(" "),a("li",[t._v("b: 代表从文件开头到第b行。")])]),t._v(" "),a("p",[t._v("例如：")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("    "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("git")]),t._v(" blame ./EOS/README.md -L  "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3,3")]),t._v("\n")])])]),a("p",[t._v("输出：a098d7cc (六弦 2021-04-19 18:07:35 +0800 3)  * @LastEditors: 六弦")]),t._v(" "),a("p",[a("strong",[t._v("node")])]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[t._v("    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" shell "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'shelljs'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    shell"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("exec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'git blame ./EOS/README.md -L  3,3'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("_code"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" stdout"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" _stderr")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("stdout"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/**\n     *  输出：\n        * a098d7cc (六弦 2021-04-19 18:07:35 +0800 3)  * @LastEditors: 六弦\n        * \n        **/")]),t._v("\n")])])]),a("h3",{attrs:{id:"通知方式"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#通知方式"}},[t._v("#")]),t._v(" 通知方式")]),t._v(" "),a("p",[t._v("目前以创建钉钉群、企业微信群机器人的方式较多，通过调用群机器人的api，将报错内容，源码位置，及源码最后的开发者信息发给群中并 @对应开发者。\n这种方式的实现比较简单，直接上钉钉机器人官方文档示例：")]),t._v(" "),a("p",[t._v("https://developers.dingtalk.com/document/app/custom-robot-access")]),t._v(" "),a("h2",{attrs:{id:"基于sentry的eos"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#基于sentry的eos"}},[t._v("#")]),t._v(" 基于Sentry的EOS")]),t._v(" "),a("blockquote",[a("p",[t._v("如果已经使用了Sentry，将减少埋点，源码追踪的过程。 因为sentry已经做了这两件事。")])]),t._v(" "),a("img",{attrs:{src:"https://melodyworld.oss-cn-beijing.aliyuncs.com/headers/EOS_sentry.jpg",width:"800",height:"600"}}),t._v(" "),a("h3",{attrs:{id:"前置条件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#前置条件"}},[t._v("#")]),t._v(" 前置条件")]),t._v(" "),a("ul",[a("li",[t._v("sentry权限账号")]),t._v(" "),a("li",[t._v("gitlab权限账号")]),t._v(" "),a("li",[t._v("开发者通讯录userId | 手机号")])]),t._v(" "),a("h3",{attrs:{id:"完整解决式方案"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#完整解决式方案"}},[t._v("#")]),t._v(" 完整解决式方案")]),t._v(" "),a("img",{attrs:{src:"https://melodyworld.oss-cn-beijing.aliyuncs.com/headers/eos-FINISH.jpg",width:"900",height:"600"}}),t._v(" "),a("h2",{attrs:{id:"现有的傻瓜式成熟方案"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#现有的傻瓜式成熟方案"}},[t._v("#")]),t._v(" 现有的傻瓜式成熟方案")]),t._v(" "),a("p",[t._v("如果贵司用的阿里云产品，那么\nhttps://help.aliyun.com/document_detail/102106.html")])])}),[],!1,null,null,null);s.default=e.exports}}]);